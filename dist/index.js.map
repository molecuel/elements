{"version":3,"sources":["index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\r\nimport mongodb = require('mongodb');\r\nimport elasticsearch = require('elasticsearch');\r\nimport 'reflect-metadata';\r\nimport * as TSV from 'tsvalidate';\r\n\r\nimport { ElasticOptions } from './classes/ElasticOptions';\r\nimport { IElement } from './interfaces/IElement';\r\nexport { Element as Element } from './classes/Element';\r\n\r\n\r\nexport class Elements {\r\n  public static loaderversion = 2;\r\n\r\n  private mongoClient: mongodb.MongoClient;\r\n  private mongoConnection: Promise<mongodb.Db>;\r\n  private elasticClient: elasticsearch.Client;\r\n  private elasticConnection: PromiseLike<elasticsearch.Client>;\r\n\r\n  private elasticOptions: ElasticOptions;\r\n  private elementStore: Map<string, IElement>;\r\n\r\n  constructor(mlcl?: any, config?: any) {\r\n    this.elementStore = new Map();\r\n    // @todo Get from config object\r\n    this.elasticOptions = new ElasticOptions();\r\n    this.elasticOptions.url = 'http://localhost:9200';\r\n    this.elasticOptions.loglevel = 'trace';\r\n    this.elasticOptions.timeout = 5000;\r\n\r\n    this.mongoClient = mongodb.MongoClient;\r\n    this.elasticClient = new elasticsearch.Client({\r\n      host: 'localhost:9200',\r\n      log: 'trace'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Wrapper for mongodb to return a promise needed by the async function\r\n   * @return {Promise<any>} [Returns the connection promise]\r\n   */\r\n  protected mongoConnectWrapper(): Promise<any> {\r\n    return this.mongoClient.connect('mongodb://localhost/elements?connectTimeoutMS=10000&socketTimeoutMS=10000', { promiseLibrary: Promise });\r\n  }\r\n\r\n  /**\r\n   * Async function for the mongo database connection\r\n   * @return {[type]} [description]\r\n   */\r\n  protected async connectMongo(): Promise<void> {\r\n    this.mongoConnection = await this.mongoConnectWrapper();\r\n  }\r\n\r\n  /**\r\n   * Return the elasticsearch connection\r\n   * @return {PromiseLike<any>} [description]\r\n   */\r\n  protected elasticConnectWrapper(): PromiseLike<any> {\r\n    return this.elasticClient.ping({\r\n      requestTimeout: this.elasticOptions.timeout,\r\n      hello: 'elasticsearch'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Async elasticsearch connection function\r\n   * @return {Promise<void>} [Return the promise for the elasticsearch connection]\r\n   */\r\n  protected async connectElastic(): Promise<void> {\r\n    this.elasticConnection = await this.elasticConnectWrapper();\r\n  }\r\n\r\n  /**\r\n   * Connect function to initialize the database connections to elastic and mongodb\r\n   * @return {[Promise]}\r\n   */\r\n  public async connect(): Promise<void> {\r\n    await this.connectElastic();\r\n    await this.connectMongo();\r\n  }\r\n\r\n  /**\r\n   * Register a class instance\r\n   * @param {string} name       [description]\r\n   * @param {any}    definition [description]\r\n   */\r\n  public registerClass(name: string, definition: any): void {\r\n    definition.elements = this;\r\n    this.elementStore.set(name, definition);\r\n  }\r\n\r\n  /**\r\n   * Get a registered class\r\n   * @param  {string}   name [description]\r\n   * @return {IElement}      [description]\r\n   */\r\n  public getClass(name: string): IElement {\r\n    return this.elementStore.get(name);\r\n  }\r\n\r\n  /**\r\n   * Return a class instance\r\n   * @param  {string}   name [description]\r\n   * @return {IElement}      [description]\r\n   */\r\n  public getClassInstance(name: string): any {\r\n    let elementClass: any = this.elementStore.get(name);\r\n    let classInstance: IElement = new elementClass();\r\n    classInstance.setFactory(this);\r\n    return classInstance;\r\n  }\r\n\r\n  /**\r\n   * Validator function for the instances\r\n   * @param  {IElement}      instance [description]\r\n   * @return {Promise<void>}          [description]\r\n   */\r\n  public validate(instance: Object): TSV.IValidatorError[] {\r\n    let validator = new TSV.Validator();\r\n    return validator.validate(instance);\r\n  }\r\n\r\n  public mongoClose(): Promise<any> {\r\n    let activeDb: any = this.mongoConnection;\r\n    return activeDb.close();\r\n  }\r\n\r\n  protected async createCollection(name: string): Promise<any> {\r\n    let activeDb: any = this.mongoConnection;\r\n    return await activeDb.createCollection(name);\r\n  }\r\n\r\n  protected async getCollections(): Promise<any> {\r\n    let activeDb: any = this.mongoConnection;\r\n    return await activeDb.collections();\r\n  }\r\n\r\n  protected async insertElements(instances: IElement[], collectionName: string, options?: mongodb.CollectionInsertManyOptions): Promise<any> {\r\n    let activeDb: any = this.mongoConnection;\r\n    let prom: any;\r\n    try {\r\n      let col: any = await activeDb.collection(collectionName);\r\n      if (col) {\r\n        prom = await col.insert(instances, options);\r\n      }\r\n    }\r\n    catch (e) {\r\n      prom = e;\r\n    }\r\n    console.log(prom);\r\n    return prom;\r\n  }\r\n\r\n  protected instanceSaveWrapper(instances: IElement[], options?: mongodb.CollectionInsertManyOptions): Promise<void> {\r\n    let errors: TSV.IValidatorError[] = [];\r\n    let collections: any = {};\r\n\r\n    // validate all instances and pre- sort into array based collections per model name;\r\n    for (let instance of instances) {\r\n      if (instance.validate().length === 0) {\r\n        if (!collections[instance.constructor.name]) {\r\n          collections[instance.constructor.name] = <IElement[]>[instance];\r\n        }\r\n        else {\r\n          collections[instance.constructor.name].push(<IElement>instance);\r\n        }\r\n      }\r\n      else {\r\n        errors.concat(instance.validate());\r\n      }\r\n    }\r\n    // every instance ok?: create non-existent DB-collections, then save instances to respective collection\r\n    if (this.mongoConnection\r\n      && errors.length === 0) {\r\n      for (let collectionName in collections) {\r\n        try {\r\n          let collectionFullName: string = 'config.projectPrefix_' + collectionName;\r\n          // this.createCollection(collectionFullName);\r\n          this.insertElements(collections[collectionName], collectionFullName, options);\r\n        }\r\n        catch (e) {\r\n          return e;\r\n        }\r\n      }\r\n      // return this.getCollections();\r\n    }\r\n    else if (errors) {\r\n      return new Promise((resolve, reject) => {\r\n        reject(errors);\r\n      });\r\n    }\r\n  }\r\n\r\n  public async saveInstances(instances: IElement[]): Promise<void> {\r\n    return await this.instanceSaveWrapper(instances);\r\n  }\r\n}\r\n"],"sourceRoot":"/source/"}